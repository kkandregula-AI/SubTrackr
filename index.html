<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SubTrackr - Smart Subscription Tracker</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">

    <!-- Login / Signup Section -->
    <div id="authSection" class="card">
      <h2>Welcome to SubTrackr</h2>
      <input type="text" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <div class="btn-group">
        <button id="loginBtn">Login</button>
        <button id="signupBtn">Sign Up</button>
      </div>
      <p id="authMessage" class="message"></p>
    </div>

    <!-- Main App Section -->
    <div id="appSection" class="hidden">
      <div class="header">
        <h2>My Subscriptions</h2>
        <button id="logoutBtn">Logout</button>
      </div>

      <div class="add-subscription card">
        <input type="text" id="subName" placeholder="Subscription Name" />
        <input type="number" id="subCost" placeholder="Cost (‚Çπ)" />
        <input type="date" id="subRenewal" placeholder="Renewal Date" />
        <button id="addSubBtn">Add</button>
        <button id="updateSubBtn" class="hidden">Update</button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Cost (‚Çπ)</th>
              <th>Renewal Date</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="subscriptionBody"></tbody>
        </table>
      </div>

      <div class="total-bar">
        <strong>Total:</strong> ‚Çπ<span id="totalCost">0.00</span>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, updateDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
    apiKey: "AIzaSyAzqSUBC2QDXAHNkxI73K1Iob-hm1C6uuk",
    authDomain: "substrack-9dcd5.firebaseapp.com",
    projectId: "substrack-9dcd5",
    storageBucket: "substrack-9dcd5.firebasestorage.app",
    messagingSenderId: "935700634167",
    appId: "1:935700634167:web:bc3a79e67f0fb90dcf7db2"
    };


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authSection = document.getElementById("authSection");
    const appSection = document.getElementById("appSection");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authMessage = document.getElementById("authMessage");
    const subBody = document.getElementById("subscriptionBody");
    const totalCost = document.getElementById("totalCost");

    const subName = document.getElementById("subName");
    const subCost = document.getElementById("subCost");
    const subRenewal = document.getElementById("subRenewal");
    const addSubBtn = document.getElementById("addSubBtn");
    const updateSubBtn = document.getElementById("updateSubBtn");

    let editId = null; // Track subscription being edited

    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");

   // LOGIN button handler
   loginBtn.addEventListener("click", async () => {
   const email = emailInput.value.trim();
   const password = passwordInput.value.trim();

   if (!email || !password) {
     alert("‚ö†Ô∏è Please enter both email and password.");
     return;
   }

   try {
     await signInWithEmailAndPassword(auth, email, password);
    
   } catch (error) {
     if (error.code === "auth/user-not-found") {
        alert("‚ùå No account found. Please sign up first.");
     } else if (error.code === "auth/wrong-password") {
       alert("‚ö†Ô∏è Incorrect password. Try again.");
     } else if (error.code === "auth/invalid-email") {
       alert("‚ö†Ô∏è Invalid email format.");
     } else {
       alert("‚ö†Ô∏è " + error.message);
     }
   }
  });

  // SIGNUP button handler
  signupBtn.addEventListener("click", async () => {
  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();

  if (!email || !password) {
     alert("‚ö†Ô∏è Please enter both email and password.");
     return;
  }

  try {
    await createUserWithEmailAndPassword(auth, email, password);
    alert("üéâ Account created successfully! You can add Subscriptions now.");
  } catch (error) {
    if (error.code === "auth/email-already-in-use") {
       alert("‚ö†Ô∏è This email is already registered. Please log in instead.");
    } else if (error.code === "auth/weak-password") {
       alert("‚ö†Ô∏è Password should be at least 6 characters.");
    } else if (error.code === "auth/invalid-email") {
       alert("‚ö†Ô∏è Please enter a valid email address.");
    } else {
       alert("‚ö†Ô∏è " + error.message);
    }
  }
  });

    // ADD SUBSCRIPTION
    addSubBtn.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return;

      const name = subName.value.trim();
      const cost = parseFloat(subCost.value);
      const renewalDate = subRenewal.value;

      if (!name || !cost || !renewalDate) return alert("Please fill all fields.");

      await addDoc(collection(db, "subscriptions"), {
        uid: user.uid,
        name,
        cost,
        renewalDate
      });

      clearFields();
      loadSubscriptions(user.uid);
    });

    // EDIT SUBSCRIPTION (populate fields)
    async function editSubscription(id, data) {
      subName.value = data.name;
      subCost.value = data.cost;
      subRenewal.value = data.renewalDate;
      editId = id;
      addSubBtn.classList.add("hidden");
      updateSubBtn.classList.remove("hidden");
    }

    // UPDATE SUBSCRIPTION
    updateSubBtn.addEventListener("click", async () => {
      if (!editId) return;
      const user = auth.currentUser;
      const name = subName.value.trim();
      const cost = parseFloat(subCost.value);
      const renewalDate = subRenewal.value;

      await updateDoc(doc(db, "subscriptions", editId), { name, cost, renewalDate });

      clearFields();
      addSubBtn.classList.remove("hidden");
      updateSubBtn.classList.add("hidden");
      editId = null;
      loadSubscriptions(user.uid);
    });

    // DELETE SUBSCRIPTION (with confirmation)
      async function deleteSubscription(id, uid) {
      const confirmDelete = confirm("Are you sure you want to delete this subscription?");
      if (!confirmDelete) return; // user canceled

      try {
        await deleteDoc(doc(db, "subscriptions", id));
        //alert("‚úÖ Subscription deleted successfully!");
        loadSubscriptions(uid);
      } catch (error) {
    console.error("Error deleting subscription:", error);
    alert("‚ö†Ô∏è Failed to delete. Please try again.");
    }
   }

    // LOAD SUBSCRIPTIONS
    async function loadSubscriptions(uid) {
      const q = query(collection(db, "subscriptions"), where("uid", "==", uid));
      const querySnapshot = await getDocs(q);

      subBody.innerHTML = "";
      let total = 0;
      const today = new Date();

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const renewal = new Date(data.renewalDate);
        const diffDays = Math.floor((renewal - today) / (1000 * 60 * 60 * 24));

        total += data.cost;
        let alertText = "";
        if (diffDays < 0) alertText = `<span class="expired">Expired</span>`;
        else if (diffDays <= 3) alertText = `<span class="renewal-soon">‚ö†Ô∏è Renewal in ${diffDays} days!</span>`;
        else alertText = `<span class="active">Active</span>`;

        subBody.innerHTML += `
          <tr>
            <td>${data.name}</td>
            <td>‚Çπ${data.cost.toFixed(2)}</td>
            <td>${data.renewalDate}</td>
            <td>${alertText}</td>
            <td>
              <button class="edit-btn" title="Edit / Update" onclick='editSubscription("${docSnap.id}", ${JSON.stringify(data)})'>‚úèÔ∏è</button>
              <button class="delete-btn" title="Delete" onclick='deleteSubscription("${docSnap.id}", "${uid}")'>üóëÔ∏è</button>
            </td>
          </tr>`;
      });

      totalCost.textContent = total.toFixed(2);
    }

    // Clear Input Fields
    function clearFields() {
      subName.value = "";
      subCost.value = "";
      subRenewal.value = "";
    }

    // AUTH STATE
    onAuthStateChanged(auth, (user) => {
      if (user) {
        authSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        loadSubscriptions(user.uid);
      } else {
        authSection.classList.remove("hidden");
        appSection.classList.add("hidden");
        clearFields();
        document.getElementById("email").value = "";
        document.getElementById("password").value = "";
      }
    });

    // LOGOUT
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    //  alert("You‚Äôve been logged out successfully!");
    });

    // Expose functions globally
    window.deleteSubscription = deleteSubscription;
    window.editSubscription = editSubscription;
  </script>
</body>
</html>

